{% comment %}
  Logo Marquee Section
  Displays partner/client logos in a continuously scrolling horizontal marquee
{% endcomment %}

<style>
  #shopify-section-{{ section.id }} {
    background-color: {{ section.settings.background_color }};
    padding: {{ section.settings.padding_top }}px 0 {{ section.settings.padding_bottom }}px;
    overflow: hidden;
  }

  #shopify-section-{{ section.id }} .logo-marquee-container {
    position: relative;
    width: 100%;
  }

  {% if section.settings.title != blank %}
    #shopify-section-{{ section.id }} .marquee-title {
      text-align: center;
      font-size: {{ section.settings.title_size }}px;
      font-weight: {{ section.settings.title_weight }};
      color: {{ section.settings.title_color }};
      margin: 0 0 {{ section.settings.title_margin }}px 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
  {% endif %}

  #shopify-section-{{ section.id }} .logo-marquee-wrapper {
    position: relative;
    width: 100%;
    overflow: hidden;
    {% case section.settings.logo_size %}
      {% when 'small' %}
        height: 80px;
      {% when 'medium' %}
        height: 100px;
      {% when 'large' %}
        height: 120px;
    {% endcase %}
  }

  #shopify-section-{{ section.id }} .logo-marquee-track {
    display: flex;
    animation: marquee-{{ section.id }} {{ section.settings.scroll_speed }}s linear infinite;
  }

  @keyframes marquee-{{ section.id }} {
    0% {
      transform: translateX(0);
    }
    100% {
      transform: translateX(calc(-1 * var(--group-width, 50%)));
    }
  }

  #shopify-section-{{ section.id }} .logo-group {
    display: flex;
    flex-shrink: 0;
    align-items: center;
    gap: {{ section.settings.logo_spacing }}px;
    padding-right: {{ section.settings.logo_spacing }}px;
  }

  #shopify-section-{{ section.id }} .logo-item {
    flex-shrink: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    {% case section.settings.logo_size %}
      {% when 'small' %}
        height: 40px;
      {% when 'medium' %}
        height: 60px;
      {% when 'large' %}
        height: 80px;
    {% endcase %}
  }

  #shopify-section-{{ section.id }} .logo-image {
    {% case section.settings.logo_size %}
      {% when 'small' %}
        max-height: 40px;
        max-width: 120px;
      {% when 'medium' %}
        max-height: 60px;
        max-width: 160px;
      {% when 'large' %}
        max-height: 80px;
        max-width: 200px;
    {% endcase %}
    width: auto;
    height: auto;
    object-fit: contain;
    filter: {{ section.settings.logo_filter }};
    transition: filter 0.3s ease, transform 0.3s ease;
  }

  {% if section.settings.logo_hover_effect %}
    #shopify-section-{{ section.id }} .logo-image:hover {
      filter: none;
      transform: scale(1.05);
    }
  {% endif %}

  {% if section.settings.pause_on_hover %}
    #shopify-section-{{ section.id }} .logo-marquee-wrapper:hover .logo-marquee-track {
      animation-play-state: paused;
    }
  {% endif %}

  /* Fade edges for smooth appearance */
  {% if section.settings.fade_edges %}
    #shopify-section-{{ section.id }} .logo-marquee-wrapper::before,
    #shopify-section-{{ section.id }} .logo-marquee-wrapper::after {
      content: '';
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100px;
      z-index: 2;
      pointer-events: none;
    }

    #shopify-section-{{ section.id }} .logo-marquee-wrapper::before {
      left: 0;
      background: linear-gradient(to right, {{ section.settings.background_color }}, transparent);
    }

    #shopify-section-{{ section.id }} .logo-marquee-wrapper::after {
      right: 0;
      background: linear-gradient(to left, {{ section.settings.background_color }}, transparent);
    }
  {% endif %}

  @media screen and (max-width: 750px) {
    {% if section.settings.title != blank %}
      #shopify-section-{{ section.id }} .marquee-title {
        font-size: {{ section.settings.title_size | times: 0.85 }}px;
      }
    {% endif %}

    #shopify-section-{{ section.id }} .logo-marquee-wrapper {
      {% case section.settings.logo_size %}
        {% when 'small' %}
          height: 50px;
        {% when 'medium' %}
          height: 70px;
        {% when 'large' %}
          height: 90px;
      {% endcase %}
    }

    #shopify-section-{{ section.id }} .logo-image {
      {% case section.settings.logo_size %}
        {% when 'small' %}
          max-height: 30px;
          max-width: 100px;
        {% when 'medium' %}
          max-height: 50px;
          max-width: 140px;
        {% when 'large' %}
          max-height: 70px;
          max-width: 180px;
      {% endcase %}
    }

    #shopify-section-{{ section.id }} .logo-group {
      gap: {{ section.settings.logo_spacing | times: 0.8 }}px;
      padding-right: {{ section.settings.logo_spacing | times: 0.8 }}px;
    }
  }
</style>

<div class="logo-marquee-container">
  {% if section.settings.title != blank %}
    <h2 class="marquee-title">{{ section.settings.title }}</h2>
  {% endif %}

  <div class="logo-marquee-wrapper">
    <div class="logo-marquee-track" id="logo-track-{{ section.id }}">
      <!-- First set of logos -->
      <div class="logo-group">
        {% for block in section.blocks %}
          {% if block.type == 'logo' %}
            <div class="logo-item" {{ block.shopify_attributes }}>
              {% if block.settings.logo_image != blank %}
                {{ block.settings.logo_image | image_url: width: 400 | image_tag:
                  class: 'logo-image',
                  alt: block.settings.logo_alt | default: 'Partner logo',
                  loading: 'lazy'
                }}
              {% elsif block.settings.logo_svg != blank %}
                <div class="logo-image">
                  {{ block.settings.logo_svg }}
                </div>
              {% else %}
                <svg class="logo-image" style="width: 120px; height: 40px;" viewBox="0 0 120 40" xmlns="http://www.w3.org/2000/svg">
                  <rect x="10" y="10" width="100" height="20" fill="#e0e0e0" rx="4"/>
                  <text x="60" y="24" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" fill="#999">LOGO</text>
                </svg>
              {% endif %}
            </div>
          {% endif %}
        {% endfor %}
      </div>

      <!-- Duplicate set for seamless loop -->
      <div class="logo-group">
        {% for block in section.blocks %}
          {% if block.type == 'logo' %}
            <div class="logo-item">
              {% if block.settings.logo_image != blank %}
                {{ block.settings.logo_image | image_url: width: 400 | image_tag:
                  class: 'logo-image',
                  alt: block.settings.logo_alt | default: 'Partner logo',
                  loading: 'lazy'
                }}
              {% elsif block.settings.logo_svg != blank %}
                <div class="logo-image">
                  {{ block.settings.logo_svg }}
                </div>
              {% else %}
                <svg class="logo-image" style="width: 120px; height: 40px;" viewBox="0 0 120 40" xmlns="http://www.w3.org/2000/svg">
                  <rect x="10" y="10" width="100" height="20" fill="#e0e0e0" rx="4"/>
                  <text x="60" y="24" text-anchor="middle" font-family="Arial, sans-serif" font-size="12" fill="#999">LOGO</text>
                </svg>
              {% endif %}
            </div>
          {% endif %}
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<script>
  (function() {
    const track = document.getElementById('logo-track-{{ section.id }}');
    if (!track) return;

    const logos = track.querySelectorAll('.logo-item');
    if (logos.length === 0) return;

    function setupMarquee() {
      const containerWidth = track.parentElement.offsetWidth;
      let groups = track.querySelectorAll('.logo-group');

      // Make sure we have at least the original group
      if (groups.length === 0) return;

      const firstGroup = groups[0];

      // Remove all clones, keep only the original and its first duplicate from HTML
      while (track.children.length > 2) {
        track.removeChild(track.lastChild);
      }

      // Get the actual width of one complete logo group
      const groupWidth = firstGroup.offsetWidth;

      // Set CSS variable with the actual pixel width to move
      track.style.setProperty('--group-width', groupWidth + 'px');

      // Ensure we have enough copies for smooth scrolling
      const copiesNeeded = Math.max(2, Math.ceil((containerWidth * 2) / groupWidth));

      // Add additional copies if needed
      for (let i = track.children.length; i < copiesNeeded; i++) {
        const clone = firstGroup.cloneNode(true);
        track.appendChild(clone);
      }
    }

    // Initialize immediately
    setupMarquee();

    // Handle resize
    let resizeTimer;
    window.addEventListener('resize', function() {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(setupMarquee, 250);
    });

    // Reinitialize after load
    window.addEventListener('load', setupMarquee);
  })();
</script>

{% schema %}
{
  "name": "Logo Marquee",
  "tag": "section",
  "class": "logo-marquee-section",
  "settings": [
    {
      "type": "header",
      "content": "Title"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Section title",
      "info": "Optional title above logos"
    },
    {
      "type": "range",
      "id": "title_size",
      "label": "Title size",
      "min": 20,
      "max": 48,
      "step": 2,
      "unit": "px",
      "default": 28
    },
    {
      "type": "select",
      "id": "title_weight",
      "label": "Title weight",
      "options": [
        {
          "value": "400",
          "label": "Normal"
        },
        {
          "value": "500",
          "label": "Medium"
        },
        {
          "value": "600",
          "label": "Semi-bold"
        },
        {
          "value": "700",
          "label": "Bold"
        }
      ],
      "default": "600"
    },
    {
      "type": "color",
      "id": "title_color",
      "label": "Title color",
      "default": "#000000"
    },
    {
      "type": "range",
      "id": "title_margin",
      "label": "Space below title",
      "min": 10,
      "max": 60,
      "step": 5,
      "unit": "px",
      "default": 30
    },
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "select",
      "id": "logo_size",
      "label": "Logo size",
      "options": [
        {
          "value": "small",
          "label": "Small"
        },
        {
          "value": "medium",
          "label": "Medium"
        },
        {
          "value": "large",
          "label": "Large"
        }
      ],
      "default": "medium"
    },
    {
      "type": "range",
      "id": "logo_spacing",
      "label": "Space between logos",
      "min": 20,
      "max": 100,
      "step": 5,
      "unit": "px",
      "default": 60
    },
    {
      "type": "header",
      "content": "Animation"
    },
    {
      "type": "range",
      "id": "scroll_speed",
      "label": "Scroll speed (seconds)",
      "min": 10,
      "max": 60,
      "step": 5,
      "unit": "s",
      "default": 20,
      "info": "Time to complete one full scroll"
    },
    {
      "type": "checkbox",
      "id": "pause_on_hover",
      "label": "Pause on hover",
      "default": true
    },
    {
      "type": "header",
      "content": "Appearance"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background color",
      "default": "#ffffff"
    },
    {
      "type": "select",
      "id": "logo_filter",
      "label": "Logo filter",
      "options": [
        {
          "value": "none",
          "label": "None"
        },
        {
          "value": "grayscale(100%)",
          "label": "Grayscale"
        },
        {
          "value": "grayscale(100%) opacity(0.7)",
          "label": "Grayscale + Fade"
        },
        {
          "value": "opacity(0.7)",
          "label": "Fade"
        }
      ],
      "default": "none"
    },
    {
      "type": "checkbox",
      "id": "logo_hover_effect",
      "label": "Enable hover effect",
      "default": true,
      "info": "Removes filter and slightly enlarges logo on hover"
    },
    {
      "type": "checkbox",
      "id": "fade_edges",
      "label": "Fade edges",
      "default": false,
      "info": "Adds a fade effect at the edges of the marquee"
    },
    {
      "type": "header",
      "content": "Section spacing"
    },
    {
      "type": "range",
      "id": "padding_top",
      "label": "Padding top",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "default": 40
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "label": "Padding bottom",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "default": 40
    }
  ],
  "blocks": [
    {
      "type": "logo",
      "name": "Logo",
      "settings": [
        {
          "type": "image_picker",
          "id": "logo_image",
          "label": "Logo image"
        },
        {
          "type": "text",
          "id": "logo_alt",
          "label": "Logo alt text",
          "default": "Partner logo"
        },
        {
          "type": "html",
          "id": "logo_svg",
          "label": "Custom SVG code",
          "info": "Optional: Paste SVG code instead of uploading an image"
        },
        {
          "type": "url",
          "id": "logo_link",
          "label": "Logo link",
          "info": "Optional link when logo is clicked"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Logo Marquee",
      "blocks": [
        {
          "type": "logo",
          "settings": {
            "logo_alt": "Company 1"
          }
        },
        {
          "type": "logo",
          "settings": {
            "logo_alt": "Company 2"
          }
        },
        {
          "type": "logo",
          "settings": {
            "logo_alt": "Company 3"
          }
        },
        {
          "type": "logo",
          "settings": {
            "logo_alt": "Company 4"
          }
        },
        {
          "type": "logo",
          "settings": {
            "logo_alt": "Company 5"
          }
        },
        {
          "type": "logo",
          "settings": {
            "logo_alt": "Company 6"
          }
        },
        {
          "type": "logo",
          "settings": {
            "logo_alt": "Company 7"
          }
        },
        {
          "type": "logo",
          "settings": {
            "logo_alt": "Company 8"
          }
        },
        {
          "type": "logo",
          "settings": {
            "logo_alt": "Company 9"
          }
        },
        {
          "type": "logo",
          "settings": {
            "logo_alt": "Company 10"
          }
        }
      ]
    }
  ]
}
{% endschema %}