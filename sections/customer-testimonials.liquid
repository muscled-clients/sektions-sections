{% comment %}
  Customer Love Testimonials Section
  Displays customer testimonials with avatars in an infinite scrolling carousel
{% endcomment %}

<style>
  #shopify-section-{{ section.id }} {
    background-color: {{ section.settings.background_color }};
    padding: {{ section.settings.padding_top }}px 0 {{ section.settings.padding_bottom }}px;
    overflow: hidden;
  }

  #shopify-section-{{ section.id }} .testimonials-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 40px;
  }

  #shopify-section-{{ section.id }} .section-heading {
    text-align: center;
    margin-bottom: {{ section.settings.heading_margin }}px;
  }

  #shopify-section-{{ section.id }} .main-title {
    font-size: {{ section.settings.heading_size }}px;
    font-weight: {{ section.settings.heading_weight }};
    color: {{ section.settings.text_color }};
    margin: 0;
    line-height: 1.2;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  }

  #shopify-section-{{ section.id }} .highlight-word {
    color: {{ section.settings.highlight_color }};
  }

  #shopify-section-{{ section.id }} .testimonials-track-container {
    position: relative;
    overflow: hidden;
    margin-top: 40px;
  }

  #shopify-section-{{ section.id }} .testimonials-track {
    display: flex;
    animation: scroll-testimonials-{{ section.id }} {{ section.settings.scroll_speed }}s linear infinite;
    gap: {{ section.settings.card_gap }}px;
  }

  @keyframes scroll-testimonials-{{ section.id }} {
    0% {
      transform: translateX(0);
    }
    100% {
      transform: translateX(-50%);
    }
  }

  #shopify-section-{{ section.id }} .testimonials-group {
    display: flex;
    flex-shrink: 0;
    gap: {{ section.settings.card_gap }}px;
  }

  #shopify-section-{{ section.id }} .testimonial-card {
    position: relative;
    flex-shrink: 0;
    width: {{ section.settings.card_width }}px;
    margin-bottom: 20px;
  }

  #shopify-section-{{ section.id }} .avatar-container {
    position: relative;
    width: 60px;
    height: 60px;
    margin: 0 0 15px 30px;
    z-index: 2;
  }

  #shopify-section-{{ section.id }} .customer-avatar {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid #ffffff;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  #shopify-section-{{ section.id }} .rating-badge {
    position: absolute;
    bottom: -5px;
    right: -5px;
    background: {{ section.settings.badge_background }};
    color: {{ section.settings.badge_text_color }};
    border-radius: 50%;
    width: 28px;
    height: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 12px;
    font-weight: 600;
    border: 2px solid #ffffff;
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  }

  #shopify-section-{{ section.id }} .speech-bubble {
    background: {{ section.settings.bubble_background }};
    border-radius: 20px;
    padding: 20px 24px;
    position: relative;
    box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    margin-top: -10px;
    border: 1px solid {{ section.settings.bubble_border_color }};
  }

  #shopify-section-{{ section.id }} .speech-bubble::before {
    content: '';
    position: absolute;
    top: -8px;
    left: 20px;
    width: 0;
    height: 0;
    border-left: 10px solid transparent;
    border-right: 10px solid transparent;
    border-bottom: 10px solid {{ section.settings.bubble_background }};
  }

  #shopify-section-{{ section.id }} .testimonial-text {
    font-size: {{ section.settings.review_text_size }}px;
    line-height: 1.5;
    color: {{ section.settings.review_text_color }};
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  }

  #shopify-section-{{ section.id }}:hover .testimonials-track {
    {% if section.settings.pause_on_hover %}
      animation-play-state: paused;
    {% endif %}
  }

  @media screen and (max-width: 750px) {
    #shopify-section-{{ section.id }} .testimonials-container {
      padding: 0 20px;
    }

    #shopify-section-{{ section.id }} .main-title {
      font-size: {{ section.settings.heading_size | times: 0.8 }}px;
    }

    #shopify-section-{{ section.id }} .testimonial-card {
      width: {{ section.settings.mobile_card_width }}px;
    }

    #shopify-section-{{ section.id }} .testimonials-track {
      gap: {{ section.settings.mobile_card_gap }}px;
    }

    #shopify-section-{{ section.id }} .testimonials-group {
      gap: {{ section.settings.mobile_card_gap }}px;
    }

    #shopify-section-{{ section.id }} .speech-bubble {
      padding: 16px 20px;
    }

    #shopify-section-{{ section.id }} .testimonial-text {
      font-size: {{ section.settings.review_text_size | times: 0.9 }}px;
    }
  }
</style>

<div class="testimonials-container">
  {% if section.settings.heading != blank %}
    <div class="section-heading">
      <h2 class="main-title">
        {% assign words = section.settings.heading | split: ' ' %}
        {% assign highlight_word = section.settings.highlight_word | strip %}
        {% for word in words %}
          {% assign clean_word = word | strip %}
          {% if clean_word == highlight_word and highlight_word != blank %}
            <span class="highlight-word">{{ word }}</span>
          {% else %}
            {{ word }}
          {% endif %}
          {% unless forloop.last %} {% endunless %}
        {% endfor %}
      </h2>
    </div>
  {% endif %}

  <div class="testimonials-track-container">
    <div class="testimonials-track" id="testimonials-track-{{ section.id }}">
      {% comment %} First set of testimonials {% endcomment %}
      <div class="testimonials-group">
        {% for block in section.blocks %}
          {% if block.type == 'testimonial' %}
            <div class="testimonial-card" {{ block.shopify_attributes }}>
              <div class="avatar-container">
                {% if block.settings.avatar != blank %}
                  {{ block.settings.avatar | image_url: width: 120 | image_tag:
                    class: 'customer-avatar',
                    alt: block.settings.customer_name | default: 'Customer avatar'
                  }}
                {% else %}
                  {{ 'customer' | placeholder_svg_tag: 'customer-avatar' }}
                {% endif %}

                <div class="rating-badge">
                  {% assign rating = block.settings.rating | default: 5 %}
                  {% if rating == 5 %}
                    5★
                  {% else %}
                    {{ rating }}★
                  {% endif %}
                </div>
              </div>

              <div class="speech-bubble">
                <p class="testimonial-text">{{ block.settings.review_text }}</p>
              </div>
            </div>
          {% endif %}
        {% endfor %}
      </div>

      {% comment %} Duplicate set for seamless loop {% endcomment %}
      <div class="testimonials-group">
        {% for block in section.blocks %}
          {% if block.type == 'testimonial' %}
            <div class="testimonial-card">
              <div class="avatar-container">
                {% if block.settings.avatar != blank %}
                  {{ block.settings.avatar | image_url: width: 120 | image_tag:
                    class: 'customer-avatar',
                    alt: block.settings.customer_name | default: 'Customer avatar'
                  }}
                {% else %}
                  {{ 'customer' | placeholder_svg_tag: 'customer-avatar' }}
                {% endif %}

                <div class="rating-badge">
                  {% assign rating = block.settings.rating | default: 5 %}
                  {% if rating == 5 %}
                    5★
                  {% else %}
                    {{ rating }}★
                  {% endif %}
                </div>
              </div>

              <div class="speech-bubble">
                <p class="testimonial-text">{{ block.settings.review_text }}</p>
              </div>
            </div>
          {% endif %}
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<script>
  (function() {
    const track = document.getElementById('testimonials-track-{{ section.id }}');
    const testimonials = track.querySelectorAll('.testimonial-card');

    // Ensure smooth infinite scroll by duplicating content if needed
    function ensureSmoothScroll() {
      const containerWidth = track.parentElement.offsetWidth;
      const group = track.querySelector('.testimonials-group');
      const groupWidth = group.offsetWidth;

      // If we need more copies for smooth scrolling
      if (groupWidth < containerWidth * 2) {
        const additionalCopies = Math.ceil((containerWidth * 3) / groupWidth);
        for (let i = 0; i < additionalCopies; i++) {
          const clone = group.cloneNode(true);
          track.appendChild(clone);
        }
      }
    }

    // Run on load and resize
    if (testimonials.length > 0) {
      ensureSmoothScroll();

      let resizeTimer;
      window.addEventListener('resize', function() {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(ensureSmoothScroll, 250);
      });

      // Optional: Adjust animation duration based on content width
      {% if section.settings.auto_adjust_speed %}
        const group = track.querySelector('.testimonials-group');
        const totalWidth = group.offsetWidth;
        const baseSpeed = {{ section.settings.scroll_speed }};
        const adjustedSpeed = Math.max(10, (totalWidth / 200) * baseSpeed);
        track.style.animationDuration = adjustedSpeed + 's';
      {% endif %}
    }
  })();
</script>

{% schema %}
{
  "name": "Customer Testimonials",
  "tag": "section",
  "class": "customer-testimonials-section",
  "settings": [
    {
      "type": "header",
      "content": "Heading"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading text",
      "default": "Our customers love the product"
    },
    {
      "type": "text",
      "id": "highlight_word",
      "label": "Word to highlight",
      "default": "love",
      "info": "Enter the exact word from the heading to highlight in a different color"
    },
    {
      "type": "color",
      "id": "highlight_color",
      "label": "Highlight word color",
      "default": "#FF8B66"
    },
    {
      "type": "range",
      "id": "heading_size",
      "label": "Heading size",
      "min": 24,
      "max": 60,
      "step": 2,
      "unit": "px",
      "default": 42
    },
    {
      "type": "select",
      "id": "heading_weight",
      "label": "Heading weight",
      "options": [
        {
          "value": "400",
          "label": "Normal"
        },
        {
          "value": "500",
          "label": "Medium"
        },
        {
          "value": "600",
          "label": "Semi-bold"
        },
        {
          "value": "700",
          "label": "Bold"
        },
        {
          "value": "800",
          "label": "Extra-bold"
        }
      ],
      "default": "700"
    },
    {
      "type": "range",
      "id": "heading_margin",
      "label": "Space below heading",
      "min": 20,
      "max": 80,
      "step": 5,
      "unit": "px",
      "default": 50
    },
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "range",
      "id": "card_width",
      "label": "Card width (Desktop)",
      "min": 250,
      "max": 400,
      "step": 10,
      "unit": "px",
      "default": 320
    },
    {
      "type": "range",
      "id": "mobile_card_width",
      "label": "Card width (Mobile)",
      "min": 250,
      "max": 350,
      "step": 10,
      "unit": "px",
      "default": 280
    },
    {
      "type": "range",
      "id": "card_gap",
      "label": "Gap between cards (Desktop)",
      "min": 10,
      "max": 40,
      "step": 2,
      "unit": "px",
      "default": 20
    },
    {
      "type": "range",
      "id": "mobile_card_gap",
      "label": "Gap between cards (Mobile)",
      "min": 10,
      "max": 30,
      "step": 2,
      "unit": "px",
      "default": 16
    },
    {
      "type": "header",
      "content": "Animation"
    },
    {
      "type": "range",
      "id": "scroll_speed",
      "label": "Scroll speed (seconds)",
      "min": 15,
      "max": 60,
      "step": 5,
      "unit": "s",
      "default": 30,
      "info": "Time to complete one full scroll"
    },
    {
      "type": "checkbox",
      "id": "pause_on_hover",
      "label": "Pause on hover",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "auto_adjust_speed",
      "label": "Auto-adjust speed based on content",
      "default": false
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background color",
      "default": "#f8f8f8"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Heading color",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "bubble_background",
      "label": "Speech bubble background",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "bubble_border_color",
      "label": "Speech bubble border",
      "default": "#e5e5e5"
    },
    {
      "type": "color",
      "id": "review_text_color",
      "label": "Review text color",
      "default": "#4a4a4a"
    },
    {
      "type": "color",
      "id": "badge_background",
      "label": "Rating badge background",
      "default": "#FF4444"
    },
    {
      "type": "color",
      "id": "badge_text_color",
      "label": "Rating badge text color",
      "default": "#ffffff"
    },
    {
      "type": "header",
      "content": "Typography"
    },
    {
      "type": "range",
      "id": "review_text_size",
      "label": "Review text size",
      "min": 13,
      "max": 18,
      "step": 1,
      "unit": "px",
      "default": 15
    },
    {
      "type": "header",
      "content": "Section"
    },
    {
      "type": "range",
      "id": "padding_top",
      "label": "Padding top",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "default": 60
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "label": "Padding bottom",
      "min": 0,
      "max": 100,
      "step": 5,
      "unit": "px",
      "default": 60
    }
  ],
  "blocks": [
    {
      "type": "testimonial",
      "name": "Testimonial",
      "limit": 20,
      "settings": [
        {
          "type": "image_picker",
          "id": "avatar",
          "label": "Customer avatar"
        },
        {
          "type": "text",
          "id": "customer_name",
          "label": "Customer name",
          "default": "Customer"
        },
        {
          "type": "textarea",
          "id": "review_text",
          "label": "Review text",
          "default": "I'm absolutely in love!"
        },
        {
          "type": "range",
          "id": "rating",
          "label": "Rating",
          "min": 1,
          "max": 5,
          "step": 1,
          "default": 5
        }
      ]
    }
  ],
  "max_blocks": 20,
  "presets": [
    {
      "name": "Customer Testimonials",
      "settings": {
        "heading": "Our customers love the product",
        "highlight_word": "love",
        "highlight_color": "#FF8B66"
      },
      "blocks": [
        {
          "type": "testimonial",
          "settings": {
            "customer_name": "Sarah",
            "review_text": "I'm absolutely in love!",
            "rating": 5
          }
        },
        {
          "type": "testimonial",
          "settings": {
            "customer_name": "Emma",
            "review_text": "My skin has never felt so soft and hydrated.",
            "rating": 5
          }
        },
        {
          "type": "testimonial",
          "settings": {
            "customer_name": "Jessica",
            "review_text": "This serum is a hydration game-changer!",
            "rating": 5
          }
        },
        {
          "type": "testimonial",
          "settings": {
            "customer_name": "Maria",
            "review_text": "My skin looks brighter and more even-toned.",
            "rating": 5
          }
        },
        {
          "type": "testimonial",
          "settings": {
            "customer_name": "Lisa",
            "review_text": "My skin feels plump and dewy after just one use.",
            "rating": 5
          }
        },
        {
          "type": "testimonial",
          "settings": {
            "customer_name": "Amanda",
            "review_text": "It leaves my skin feeling soft and supple all day long.",
            "rating": 5
          }
        }
      ]
    }
  ]
}
{% endschema %}