{% comment %}
  Wear It With Section
  Shows related products with color/size selectors and add to bag functionality
{% endcomment %}

<div class="wear-it-with-section section-{{ section.id }}-padding">
  <div class="page-width">
    {% if section.settings.title != blank %}
      <h2 class="wear-it-with-title">{{ section.settings.title }}</h2>
    {% endif %}

    <div class="wear-it-with-products">
      {% for block in section.blocks %}
        {% if block.settings.product != blank %}
          {% assign product = block.settings.product %}
          <div class="wear-it-with-product-card" {{ block.shopify_attributes }}>

            {%- comment -%} Product Image {%- endcomment -%}
            <div class="product-card-image">
              {% if product.featured_image %}
                <img
                  src="{{ product.featured_image | image_url: width: 200 }}"
                  alt="{{ product.featured_image.alt | escape }}"
                  loading="lazy"
                  width="100"
                  height="100"
                >
              {% else %}
                {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
              {% endif %}
            </div>

            {%- comment -%} Product Info {%- endcomment -%}
            <div class="product-card-info">
              <div class="product-basic-info">
                <h3 class="product-card-title">{{ product.title }}</h3>
                <p class="product-card-price">{{ product.price | money }}</p>
              </div>
            </div>

            {%- comment -%} Color and Size Selectors {%- endcomment -%}
            <div class="product-card-options-wrapper">
              {% assign color_option = null %}
              {% assign size_option = null %}

              {% for option in product.options_with_values %}
                {% assign option_name_lower = option.name | downcase %}
                {% if option_name_lower == "color" or option_name_lower == "colour" %}
                  {% assign color_option = option %}
                {% endif %}
                {% if option_name_lower == "size" %}
                  {% assign size_option = option %}
                {% endif %}
              {% endfor %}

              <div class="product-card-options">
                {%- comment -%} Color Selector {%- endcomment -%}
                <div class="option-group">
                  {% if color_option and color_option.values.size > 0 %}
                    <label class="option-label">Color: <span class="selected-color">{{ color_option.values.first }}</span></label>
                    <div class="color-swatches">
                      {% for value in color_option.values %}
                        <button
                          type="button"
                          class="color-swatch {% if forloop.first %}active{% endif %}"
                          data-value="{{ value | escape }}"
                          data-product-id="{{ product.id }}"
                          data-option-name="Color"
                          title="{{ value | escape }}"
                        >
                          <span class="visually-hidden">{{ value }}</span>
                        </button>
                      {% endfor %}
                    </div>
                  {% else %}
                    {%- comment -%} Fallback: Show default colors {%- endcomment -%}
                    <label class="option-label">Color: <span class="selected-color">Ivory</span></label>
                    <div class="color-swatches">
                      <button type="button" class="color-swatch active" data-value="Ivory" data-product-id="{{ product.id }}" title="Ivory">
                        <span class="visually-hidden">Ivory</span>
                      </button>
                      <button type="button" class="color-swatch" data-value="Black" data-product-id="{{ product.id }}" title="Black">
                        <span class="visually-hidden">Black</span>
                      </button>
                      <button type="button" class="color-swatch" data-value="Yellow" data-product-id="{{ product.id }}" title="Yellow">
                        <span class="visually-hidden">Yellow</span>
                      </button>
                      <button type="button" class="color-swatch" data-value="Green" data-product-id="{{ product.id }}" title="Green">
                        <span class="visually-hidden">Green</span>
                      </button>
                      <button type="button" class="color-swatch" data-value="Teal" data-product-id="{{ product.id }}" title="Teal">
                        <span class="visually-hidden">Teal</span>
                      </button>
                      <button type="button" class="color-swatch" data-value="Pink" data-product-id="{{ product.id }}" title="Pink">
                        <span class="visually-hidden">Pink</span>
                      </button>
                    </div>
                  {% endif %}
                </div>

                {%- comment -%} Size Selector {%- endcomment -%}
                <div class="option-group">
                  {% if size_option and size_option.values.size > 0 %}
                    <label class="option-label">Size: <span class="selected-size">{{ size_option.values.first }}</span></label>
                    <div class="size-buttons">
                      {% for value in size_option.values %}
                        <button
                          type="button"
                          class="size-button {% if forloop.first %}active{% endif %}"
                          data-value="{{ value | escape }}"
                          data-product-id="{{ product.id }}"
                          data-option-name="Size"
                        >
                          {{ value }}
                        </button>
                      {% endfor %}
                    </div>
                  {% else %}
                    {%- comment -%} Fallback: Show default sizes {%- endcomment -%}
                    <label class="option-label">Size: <span class="selected-size">XS</span></label>
                    <div class="size-buttons">
                      <button type="button" class="size-button active" data-value="XS" data-product-id="{{ product.id }}">XS</button>
                      <button type="button" class="size-button" data-value="S" data-product-id="{{ product.id }}">S</button>
                      <button type="button" class="size-button" data-value="M" data-product-id="{{ product.id }}">M</button>
                      <button type="button" class="size-button" data-value="L" data-product-id="{{ product.id }}">L</button>
                    </div>
                  {% endif %}
                </div>
              </div>
            </div>

            {%- comment -%} Add to Bag Button {%- endcomment -%}
            <div class="product-card-actions">
              <button
                type="button"
                class="add-to-bag-button"
                data-product-id="{{ product.id }}"
                data-variant-id="{{ product.selected_or_first_available_variant.id }}"
              >
                {{ block.settings.button_text | default: 'ADD TO BAG' }}
              </button>
            </div>

          </div>
        {% endif %}
      {% endfor %}
    </div>
  </div>
</div>

<style>
  .wear-it-with-section {
    margin: 50px 0;
  }

  .section-{{ section.id }}-padding {
    padding-top: {{ section.settings.padding_top }}px;
    padding-bottom: {{ section.settings.padding_bottom }}px;
  }

  .wear-it-with-title {
    font-size: 13px;
    font-weight: 700;
    letter-spacing: 1.5px;
    text-transform: uppercase;
    margin: 0 0 20px 0;
    color: #000;
  }

  .wear-it-with-products {
    background: #fff;
  }

  .wear-it-with-product-card {
    display: flex;
    align-items: center;
    padding: 20px 0;
    gap: 20px;
    border-top: 1px solid #D9D9D9;
    border-bottom: 1px solid #D9D9D9;
    background: #fff;
    position: relative;
  }

  .wear-it-with-product-card:first-child {
    border-top: 1px solid #D9D9D9;
  }

  .wear-it-with-product-card + .wear-it-with-product-card {
    border-top: none;
  }

  /* Product Image */
  .product-card-image {
    flex-shrink: 0;
    width: 207px;
    height: 289.8px;
    aspect-ratio: 207 / 289.8;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #fafafa;
  }

  .product-card-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .product-card-image .placeholder-svg {
    width: 100%;
    height: 100%;
    fill: #e5e5e5;
  }

  /* Product Info */
  .product-card-info {
    flex-shrink: 0;
  }

  .product-basic-info {
    flex-shrink: 0;
  }

  .product-card-title {
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 0.8px;
    text-transform: uppercase;
    margin: 0 0 2px 0;
    color: #000;
    line-height: 1.2;
    white-space: nowrap;
  }

  .product-card-price {
    font-size: 12px;
    font-weight: 400;
    margin: 0;
    color: #000;
    line-height: 1.2;
    white-space: nowrap;
  }

  /* Options Wrapper - Centered */
  .product-card-options-wrapper {
    flex: 1;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  /* Options */
  .product-card-options {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .option-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
  }

  .option-label {
    font-size: 10px;
    font-weight: 400;
    color: #999;
    margin: 0;
    line-height: 1.2;
  }

  .option-label .selected-color,
  .option-label .selected-size {
    font-weight: 400;
    color: #999;
  }

  /* Color Swatches */
  .color-swatches {
    display: flex;
    gap: 6px;
    align-items: center;
  }

  .color-swatch {
    width: 18px;
    height: 18px;
    border-radius: 50%;
    border: 1px solid #ddd;
    cursor: pointer;
    padding: 0;
    transition: all 0.15s ease;
    position: relative;
    background: #fff;
  }

  .color-swatch:hover {
    transform: scale(1.08);
  }

  .color-swatch.active {
    border-color: #000;
    border-width: 2px;
  }

  /* Color swatch colors - customize based on your product variants */
  .color-swatch[data-value*="Ivory"],
  .color-swatch[data-value*="ivory"],
  .color-swatch[data-value*="White"],
  .color-swatch[data-value*="white"] {
    background-color: #ede9e3 !important;
  }

  .color-swatch[data-value*="Black"],
  .color-swatch[data-value*="black"] {
    background-color: #1a1a1a !important;
  }

  .color-swatch[data-value*="Yellow"],
  .color-swatch[data-value*="yellow"],
  .color-swatch[data-value*="Gold"],
  .color-swatch[data-value*="gold"] {
    background-color: #f3e5a0 !important;
  }

  .color-swatch[data-value*="Green"],
  .color-swatch[data-value*="green"],
  .color-swatch[data-value*="Lime"],
  .color-swatch[data-value*="lime"] {
    background-color: #c8d96f !important;
  }

  .color-swatch[data-value*="Teal"],
  .color-swatch[data-value*="teal"],
  .color-swatch[data-value*="Turquoise"],
  .color-swatch[data-value*="turquoise"],
  .color-swatch[data-value*="Aqua"],
  .color-swatch[data-value*="aqua"] {
    background-color: #7db8a8 !important;
  }

  .color-swatch[data-value*="Pink"],
  .color-swatch[data-value*="pink"],
  .color-swatch[data-value*="Beige"],
  .color-swatch[data-value*="beige"],
  .color-swatch[data-value*="Tan"],
  .color-swatch[data-value*="tan"] {
    background-color: #d9bfad !important;
  }

  .color-swatch[data-value*="Gray"],
  .color-swatch[data-value*="gray"],
  .color-swatch[data-value*="Grey"],
  .color-swatch[data-value*="grey"] {
    background-color: #9a9a9a !important;
  }

  .color-swatch[data-value*="Blue"],
  .color-swatch[data-value*="blue"] {
    background-color: #6ba4d4 !important;
  }

  .color-swatch[data-value*="Red"],
  .color-swatch[data-value*="red"] {
    background-color: #d46b6b !important;
  }

  /* Size Buttons */
  .size-buttons {
    display: flex;
    gap: 4px;
    align-items: center;
  }

  .size-button {
    min-width: 32px;
    height: 24px;
    padding: 0 9px;
    font-size: 10px;
    font-weight: 400;
    color: #000;
    background: #fff;
    border: 1px solid #ccc;
    cursor: pointer;
    transition: all 0.15s ease;
    text-transform: uppercase;
    line-height: 1;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .size-button:hover {
    border-color: #000;
  }

  .size-button.active {
    background: #000;
    color: #fff;
    border-color: #000;
  }

  /* Add to Bag Button */
  .product-card-actions {
    flex-shrink: 0;
    margin-left: auto;
  }

  .add-to-bag-button {
    background: #000;
    color: #fff;
    border: none;
    padding: 12px 36px;
    font-size: 10px;
    font-weight: 700;
    letter-spacing: 1px;
    text-transform: uppercase;
    cursor: pointer;
    transition: opacity 0.2s ease;
    white-space: nowrap;
    line-height: 1;
  }

  .add-to-bag-button:hover {
    opacity: 0.9;
  }

  .add-to-bag-button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* Visually Hidden */
  .visually-hidden {
    position: absolute;
    width: 1px;
    height: 1px;
    margin: -1px;
    padding: 0;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    border: 0;
  }

  /* Responsive Design */
  @media screen and (max-width: 989px) {
    .wear-it-with-product-card {
      flex-wrap: wrap;
      gap: 15px;
      padding: 20px 15px;
    }

    .product-card-image {
      width: 120px;
      height: 168px;
      aspect-ratio: 207 / 289.8;
    }

    .product-card-info {
      width: 100%;
    }

    .product-basic-info {
      min-width: auto;
    }

    .product-card-options-wrapper {
      width: 100%;
      justify-content: flex-start;
    }

    .product-card-actions {
      width: 100%;
      margin-left: 0;
    }

    .add-to-bag-button {
      width: 100%;
    }
  }

  @media screen and (max-width: 749px) {
    .wear-it-with-title {
      font-size: 11px;
      margin-bottom: 15px;
      letter-spacing: 1.2px;
    }

    .wear-it-with-product-card {
      padding: 18px 12px;
      gap: 12px;
    }

    .product-card-image {
      width: 90px;
      height: 126px;
      aspect-ratio: 207 / 289.8;
    }

    .product-card-info {
      width: 100%;
    }

    .product-basic-info {
      min-width: auto;
    }

    .product-card-options-wrapper {
      width: 100%;
      justify-content: flex-start;
    }

    .product-card-actions {
      width: 100%;
      margin-left: 0;
    }

    .product-card-title {
      font-size: 10px;
      letter-spacing: 0.6px;
      white-space: normal;
    }

    .product-card-price {
      font-size: 11px;
      white-space: normal;
    }

    .option-label {
      font-size: 9px;
    }

    .color-swatch {
      width: 16px;
      height: 16px;
    }

    .size-button {
      min-width: 28px;
      height: 22px;
      font-size: 9px;
      padding: 0 7px;
    }

    .add-to-bag-button {
      padding: 12px 24px;
      font-size: 9px;
      letter-spacing: 0.8px;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const productCards = document.querySelectorAll('.wear-it-with-product-card');

    productCards.forEach(card => {
      const colorSwatches = card.querySelectorAll('.color-swatch');
      const sizeButtons = card.querySelectorAll('.size-button');
      const addToCartBtn = card.querySelector('.add-to-bag-button');
      const selectedColorLabel = card.querySelector('.selected-color');
      const selectedSizeLabel = card.querySelector('.selected-size');
      const productId = addToCartBtn?.getAttribute('data-product-id');

      let selectedColor = colorSwatches.length > 0 ? colorSwatches[0].getAttribute('data-value') : null;
      let selectedSize = sizeButtons.length > 0 ? sizeButtons[0].getAttribute('data-value') : null;

      // Color swatch selection
      colorSwatches.forEach(swatch => {
        swatch.addEventListener('click', function() {
          colorSwatches.forEach(s => s.classList.remove('active'));
          this.classList.add('active');
          selectedColor = this.getAttribute('data-value');
          if (selectedColorLabel) {
            selectedColorLabel.textContent = selectedColor;
          }
          updateVariant();
        });
      });

      // Size button selection
      sizeButtons.forEach(button => {
        button.addEventListener('click', function() {
          sizeButtons.forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          selectedSize = this.getAttribute('data-value');
          if (selectedSizeLabel) {
            selectedSizeLabel.textContent = selectedSize;
          }
          updateVariant();
        });
      });

      // Add to cart functionality
      if (addToCartBtn) {
        addToCartBtn.addEventListener('click', function() {
          const variantId = this.getAttribute('data-variant-id');

          if (!variantId) {
            alert('Please select a variant');
            return;
          }

          addToCartBtn.disabled = true;
          const originalText = addToCartBtn.textContent;
          addToCartBtn.textContent = 'ADDING...';

          fetch('/cart/add.js', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              id: variantId,
              quantity: 1
            })
          })
          .then(response => response.json())
          .then(data => {
            // Trigger cart drawer/notification (customize based on your theme)
            if (typeof window.theme !== 'undefined' && typeof window.theme.cart !== 'undefined') {
              window.theme.cart.refresh();
            }

            // Update cart count if available
            fetch('/cart.js')
              .then(res => res.json())
              .then(cart => {
                const cartCountElements = document.querySelectorAll('.cart-count, [data-cart-count]');
                cartCountElements.forEach(el => {
                  el.textContent = cart.item_count;
                });
              });

            addToCartBtn.textContent = 'ADDED!';
            setTimeout(() => {
              addToCartBtn.textContent = originalText;
              addToCartBtn.disabled = false;
            }, 2000);
          })
          .catch(error => {
            console.error('Error adding to cart:', error);
            alert('Error adding to cart. Please try again.');
            addToCartBtn.textContent = originalText;
            addToCartBtn.disabled = false;
          });
        });
      }

      // Update variant based on selected options
      function updateVariant() {
        if (!productId) return;

        fetch(`/products/${productId}.js`)
          .then(response => response.json())
          .then(product => {
            const variant = product.variants.find(v => {
              const matchesColor = !selectedColor || v.options.includes(selectedColor);
              const matchesSize = !selectedSize || v.options.includes(selectedSize);
              return matchesColor && matchesSize;
            });

            if (variant && addToCartBtn) {
              addToCartBtn.setAttribute('data-variant-id', variant.id);
              addToCartBtn.disabled = !variant.available;

              const originalText = addToCartBtn.getAttribute('data-original-text');
              if (!variant.available) {
                addToCartBtn.textContent = 'SOLD OUT';
              } else {
                addToCartBtn.textContent = originalText || 'ADD TO BAG';
              }
            }
          })
          .catch(error => {
            console.error('Error fetching product:', error);
          });
      }

      // Store original button text
      if (addToCartBtn) {
        addToCartBtn.setAttribute('data-original-text', addToCartBtn.textContent);
      }
    });
  });
</script>

{% schema %}
{
  "name": "Wear It With",
  "tag": "section",
  "class": "section-wear-it-with",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Section Title",
      "default": "WEAR IT WITH"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Padding Top",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Padding Bottom",
      "default": 36
    }
  ],
  "blocks": [
    {
      "type": "product",
      "name": "Product",
      "limit": 4,
      "settings": [
        {
          "type": "product",
          "id": "product",
          "label": "Product"
        },
        {
          "type": "text",
          "id": "button_text",
          "label": "Button Text",
          "default": "ADD TO BAG"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Wear It With",
      "category": "Product"
    }
  ]
}
{% endschema %}
