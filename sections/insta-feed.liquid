{% comment %}
  SEK Instafeed Grid - Instagram-style masonry grid with header
{% endcomment %}

{%- assign section_id = section.id -%}

{% style %}
  #sek-ig-{{ section_id }} {
    background: {{ section.settings.background_color }};
  }

  #sek-ig-{{ section_id }} .sek-ig__container {
    {%- if section.settings.full_width -%}
    max-width: 100%;
    padding: {{ section.settings.padding_top_mobile }}px 0 {{ section.settings.padding_bottom_mobile }}px;
    {%- else -%}
    max-width: {{ section.settings.max_width }}px;
    padding: {{ section.settings.padding_top_mobile }}px 16px {{ section.settings.padding_bottom_mobile }}px;
    margin: 0 auto;
    {%- endif -%}
  }

  @media (min-width: 750px) {
    #sek-ig-{{ section_id }} .sek-ig__container {
      {%- if section.settings.full_width -%}
      padding: {{ section.settings.padding_top }}px 0 {{ section.settings.padding_bottom }}px;
      {%- else -%}
      padding: {{ section.settings.padding_top }}px 40px {{ section.settings.padding_bottom }}px;
      {%- endif -%}
    }
  }

  @media (min-width: 1200px) {
    #sek-ig-{{ section_id }} .sek-ig__container {
      {%- unless section.settings.full_width -%}
      padding: {{ section.settings.padding_top }}px 60px {{ section.settings.padding_bottom }}px;
      {%- endunless -%}
    }
  }

  /* Header */
  #sek-ig-{{ section_id }} .sek-ig__header {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 24px;
    {%- if section.settings.full_width -%}
    padding: 0 16px;
    {%- endif -%}
  }

  @media (min-width: 750px) {
    #sek-ig-{{ section_id }} .sek-ig__header {
      flex-direction: row;
      justify-content: space-between;
      align-items: flex-end;
      margin-bottom: 32px;
      {%- if section.settings.full_width -%}
      padding: 0 40px;
      {%- endif -%}
    }
  }

  @media (min-width: 1200px) {
    #sek-ig-{{ section_id }} .sek-ig__header {
      {%- if section.settings.full_width -%}
      padding: 0 60px;
      {%- endif -%}
    }
  }

  #sek-ig-{{ section_id }} .sek-ig__header-content {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  #sek-ig-{{ section_id }} .sek-ig__label {
    font-size: 12px;
    font-weight: 400;
    letter-spacing: 1px;
    text-transform: uppercase;
    color: {{ section.settings.label_color }};
    margin: 0;
  }

  #sek-ig-{{ section_id }} .sek-ig__heading {
    font-size: 28px;
    font-weight: 700;
    line-height: 1.1;
    color: {{ section.settings.heading_color }};
    margin: 0;
  }

  @media (min-width: 750px) {
    #sek-ig-{{ section_id }} .sek-ig__heading {
      font-size: 48px;
    }
  }

  @media (min-width: 1024px) {
    #sek-ig-{{ section_id }} .sek-ig__heading {
      font-size: 56px;
    }
  }

  #sek-ig-{{ section_id }} .sek-ig__description {
    font-size: 14px;
    line-height: 1.5;
    color: {{ section.settings.text_color }};
    margin: 0;
  }

  @media (min-width: 750px) {
    #sek-ig-{{ section_id }} .sek-ig__description {
      font-size: 18px;
    }
  }

  #sek-ig-{{ section_id }} .sek-ig__button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: {{ section.settings.button_bg }};
    color: {{ section.settings.button_text_color }};
    padding: 14px 48px;
    font-size: 14px;
    font-weight: 400;
    text-decoration: none;
    border-radius: 100px;
    transition: background 0.3s ease;
    white-space: nowrap;
    margin-top: 8px;
  }

  @media (min-width: 750px) {
    #sek-ig-{{ section_id }} .sek-ig__button {
      padding: 18px 72px;
      margin-top: 0;
    }
  }

  #sek-ig-{{ section_id }} .sek-ig__button:hover {
    background: {{ section.settings.button_hover_bg }};
  }

  /* Grid */
  #sek-ig-{{ section_id }} .sek-ig__grid {
    display: grid;
    grid-template-columns: repeat({{ section.settings.columns_mobile }}, 1fr);
    gap: {{ section.settings.gap }}px;
  }

  @media (min-width: 750px) {
    #sek-ig-{{ section_id }} .sek-ig__grid {
      grid-template-columns: repeat({{ section.settings.columns_tablet }}, 1fr);
    }
  }

  @media (min-width: 1024px) {
    #sek-ig-{{ section_id }} .sek-ig__grid {
      grid-template-columns: repeat({{ section.settings.columns_desktop }}, 1fr);
    }
  }

  /* Grid Items */
  #sek-ig-{{ section_id }} .sek-ig__item {
    position: relative;
    overflow: hidden;
    cursor: pointer;
    border-radius: {{ section.settings.border_radius }}px;
    backface-visibility: hidden;
    transform: translateZ(0);
    aspect-ratio: 9 / 16;
  }

  #sek-ig-{{ section_id }} .sek-ig__item img,
  #sek-ig-{{ section_id }} .sek-ig__item video,
  #sek-ig-{{ section_id }} .sek-ig__item svg {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.25s ease;
    backface-visibility: hidden;
  }

  #sek-ig-{{ section_id }} .sek-ig__item:hover img,
  #sek-ig-{{ section_id }} .sek-ig__item:hover video {
    transform: scale(1.05);
  }

  /* Video Icon */
  #sek-ig-{{ section_id }} .sek-ig__video-icon {
    position: absolute;
    bottom: 12px;
    left: 12px;
    width: 32px;
    height: 32px;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    pointer-events: none;
    transition: opacity 0.2s ease;
  }

  #sek-ig-{{ section_id }} .sek-ig__video-icon svg {
    width: 12px;
    height: 12px;
    fill: #ffffff;
  }

  /* Link overlay */
  #sek-ig-{{ section_id }} .sek-ig__link {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 3;
  }

  /* Hover overlay */
  #sek-ig-{{ section_id }} .sek-ig__overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0);
    transition: background 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 2;
  }

  #sek-ig-{{ section_id }} .sek-ig__item:hover .sek-ig__overlay {
    background: rgba(0, 0, 0, 0.2);
  }

  #sek-ig-{{ section_id }} .sek-ig__overlay-icon {
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  #sek-ig-{{ section_id }} .sek-ig__item:hover .sek-ig__overlay-icon {
    opacity: 1;
  }

  #sek-ig-{{ section_id }} .sek-ig__overlay-icon svg {
    width: 32px;
    height: 32px;
    fill: #ffffff;
  }

  /* Video Styles */
  #sek-ig-{{ section_id }} .sek-ig__video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.25s ease;
    backface-visibility: hidden;
  }

  #sek-ig-{{ section_id }} .sek-ig__item--video:hover .sek-ig__video {
    transform: scale(1.05);
  }

  /* Play/Pause Button */
  #sek-ig-{{ section_id }} .sek-ig__play-btn {
    position: absolute;
    bottom: 12px;
    left: 12px;
    width: 36px;
    height: 36px;
    background: rgba(0, 0, 0, 0.4);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 4;
    transition: all 0.25s ease;
    padding: 0;
  }

  #sek-ig-{{ section_id }} .sek-ig__play-btn:hover {
    background: rgba(0, 0, 0, 0.6);
    transform: scale(1.1);
  }

  #sek-ig-{{ section_id }} .sek-ig__play-btn svg {
    width: 16px;
    height: 16px;
    fill: #ffffff;
  }

  #sek-ig-{{ section_id }} .sek-ig__icon-play {
    display: block;
  }

  #sek-ig-{{ section_id }} .sek-ig__icon-pause {
    display: none;
  }

  #sek-ig-{{ section_id }} .sek-ig__play-btn[data-playing="true"] .sek-ig__icon-play {
    display: none;
  }

  #sek-ig-{{ section_id }} .sek-ig__play-btn[data-playing="true"] .sek-ig__icon-pause {
    display: block;
  }

{% endstyle %}

<div id="sek-ig-{{ section_id }}" class="sek-ig">
  <div class="sek-ig__container">
  <!-- Header -->
  {%- if section.settings.show_header -%}
  <div class="sek-ig__header">
    <div class="sek-ig__header-content">
      {%- if section.settings.label != blank -%}
        <p class="sek-ig__label">{{ section.settings.label }}</p>
      {%- endif -%}

      {%- if section.settings.heading != blank -%}
        <h2 class="sek-ig__heading">{{ section.settings.heading }}</h2>
      {%- endif -%}

      {%- if section.settings.description != blank -%}
        <p class="sek-ig__description">{{ section.settings.description }}</p>
      {%- endif -%}
    </div>

    {%- if section.settings.button_text != blank -%}
      <a href="{{ section.settings.button_link | default: '#' }}" class="sek-ig__button" {% if section.settings.button_link contains 'instagram' or section.settings.button_link contains 'tiktok' %}target="_blank" rel="noopener"{% endif %}>
        {{ section.settings.button_text }}
      </a>
    {%- endif -%}
  </div>
  {%- endif -%}

  <!-- Grid -->
  <div class="sek-ig__grid">
    {%- for block in section.blocks -%}
      <div class="sek-ig__item{% if block.settings.video %} sek-ig__item--video{% endif %}" data-index="{{ forloop.index0 }}" {{ block.shopify_attributes }}>
        {%- if block.settings.video -%}
          <!-- Video -->
          <video
            class="sek-ig__video"
            src="{{ block.settings.video.sources[1].url }}"
            poster="{%- if block.settings.image -%}{{ block.settings.image | image_url: width: 800 }}{%- endif -%}"
            loop
            muted
            playsinline
            preload="metadata"
          ></video>

          <!-- Play/Pause Button -->
          <button class="sek-ig__play-btn" aria-label="Play video" data-playing="false">
            <svg class="sek-ig__icon-play" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path d="M8 5v14l11-7z"/>
            </svg>
            <svg class="sek-ig__icon-pause" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>
            </svg>
          </button>
        {%- elsif block.settings.image -%}
          <!-- Image -->
          <img
            src="{{ block.settings.image | image_url: width: 800 }}"
            srcset="{{ block.settings.image | image_url: width: 400 }} 400w,
                    {{ block.settings.image | image_url: width: 600 }} 600w,
                    {{ block.settings.image | image_url: width: 800 }} 800w"
            sizes="{% if is_large %}(max-width: 749px) 100vw, 30vw{% else %}(max-width: 749px) 50vw, 15vw{% endif %}"
            alt="{{ block.settings.image.alt | default: 'Instagram post' }}"
            loading="lazy"
          >

          <div class="sek-ig__overlay">
            <div class="sek-ig__overlay-icon">
              <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
              </svg>
            </div>
          </div>
        {%- else -%}
          <!-- Placeholder -->
          {%- assign placeholder_num = forloop.index0 | modulo: 6 | plus: 1 -%}
          {{ 'collection-' | append: placeholder_num | placeholder_svg_tag }}
        {%- endif -%}

        {%- if block.settings.link != blank and block.settings.video == blank -%}
          <a href="{{ block.settings.link }}" class="sek-ig__link" target="_blank" rel="noopener" aria-label="View on Instagram"></a>
        {%- endif -%}
      </div>
    {%- endfor -%}
  </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const section = document.getElementById('sek-ig-{{ section_id }}');
    if (!section) return;

    const playButtons = section.querySelectorAll('.sek-ig__play-btn');

    playButtons.forEach(btn => {
      const item = btn.closest('.sek-ig__item');
      const video = item.querySelector('.sek-ig__video');

      if (!video) return;

      btn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();

        const isPlaying = btn.getAttribute('data-playing') === 'true';

        if (isPlaying) {
          video.pause();
          btn.setAttribute('data-playing', 'false');
          btn.setAttribute('aria-label', 'Play video');
        } else {
          // Pause all other videos first
          section.querySelectorAll('.sek-ig__video').forEach(v => {
            if (v !== video) {
              v.pause();
              const otherBtn = v.closest('.sek-ig__item').querySelector('.sek-ig__play-btn');
              if (otherBtn) {
                otherBtn.setAttribute('data-playing', 'false');
                otherBtn.setAttribute('aria-label', 'Play video');
              }
            }
          });

          video.play();
          btn.setAttribute('data-playing', 'true');
          btn.setAttribute('aria-label', 'Pause video');
        }
      });

      // Update button state when video ends
      video.addEventListener('ended', function() {
        btn.setAttribute('data-playing', 'false');
        btn.setAttribute('aria-label', 'Play video');
      });

      // Handle video pause from other sources
      video.addEventListener('pause', function() {
        btn.setAttribute('data-playing', 'false');
        btn.setAttribute('aria-label', 'Play video');
      });

      video.addEventListener('play', function() {
        btn.setAttribute('data-playing', 'true');
        btn.setAttribute('aria-label', 'Pause video');
      });
    });
  });
</script>

{% schema %}
{
  "name": "SEK Instafeed Grid",
  "tag": "section",
  "class": "sek-instafeed-grid",
  "settings": [
    {
      "type": "header",
      "content": "Layout"
    },
    {
      "type": "checkbox",
      "id": "full_width",
      "label": "Full width",
      "default": true,
      "info": "Extend grid edge to edge"
    },
    {
      "type": "checkbox",
      "id": "show_header",
      "label": "Show header",
      "default": false
    },
    {
      "type": "header",
      "content": "Header"
    },
    {
      "type": "text",
      "id": "label",
      "label": "Label",
      "default": "FOLLOW US ON SOCIALS"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Tune in, for good stuff."
    },
    {
      "type": "textarea",
      "id": "description",
      "label": "Description",
      "default": "Sales, music, events and more..."
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Button text",
      "default": "@undabrand"
    },
    {
      "type": "url",
      "id": "button_link",
      "label": "Button link",
      "info": "Link to your Instagram profile"
    },
    {
      "type": "header",
      "content": "Grid"
    },
    {
      "type": "range",
      "id": "columns_mobile",
      "label": "Columns (mobile)",
      "min": 2,
      "max": 4,
      "step": 1,
      "default": 2
    },
    {
      "type": "range",
      "id": "columns_tablet",
      "label": "Columns (tablet)",
      "min": 3,
      "max": 6,
      "step": 1,
      "default": 4
    },
    {
      "type": "range",
      "id": "columns_desktop",
      "label": "Columns (desktop)",
      "min": 4,
      "max": 8,
      "step": 1,
      "default": 6
    },
    {
      "type": "range",
      "id": "gap",
      "label": "Gap between items",
      "min": 0,
      "max": 16,
      "step": 1,
      "default": 0,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "border_radius",
      "label": "Border radius",
      "min": 0,
      "max": 24,
      "step": 2,
      "default": 0,
      "unit": "px"
    },
    {
      "type": "header",
      "content": "Section Spacing"
    },
    {
      "type": "range",
      "id": "max_width",
      "label": "Max width",
      "min": 1000,
      "max": 1800,
      "step": 50,
      "default": 1400,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "padding_top",
      "label": "Padding top (desktop)",
      "min": 0,
      "max": 100,
      "step": 5,
      "default": 0,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "label": "Padding bottom (desktop)",
      "min": 0,
      "max": 100,
      "step": 5,
      "default": 0,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "padding_top_mobile",
      "label": "Padding top (mobile)",
      "min": 0,
      "max": 60,
      "step": 5,
      "default": 0,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "padding_bottom_mobile",
      "label": "Padding bottom (mobile)",
      "min": 0,
      "max": 60,
      "step": 5,
      "default": 0,
      "unit": "px"
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background color",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "label_color",
      "label": "Label color",
      "default": "#666666"
    },
    {
      "type": "color",
      "id": "heading_color",
      "label": "Heading color",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text color",
      "default": "#333333"
    },
    {
      "type": "color",
      "id": "button_bg",
      "label": "Button background",
      "default": "#181414"
    },
    {
      "type": "color",
      "id": "button_text_color",
      "label": "Button text color",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "button_hover_bg",
      "label": "Button hover background",
      "default": "#953033"
    }
  ],
  "blocks": [
    {
      "type": "media",
      "name": "Media",
      "settings": [
        {
          "type": "image_picker",
          "id": "image",
          "label": "Image",
          "info": "Used as poster for videos or standalone image"
        },
        {
          "type": "video",
          "id": "video",
          "label": "Video",
          "info": "Optional: Upload video for this item"
        },
        {
          "type": "url",
          "id": "link",
          "label": "Link",
          "info": "Link to Instagram post (images only)"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "SEK Instafeed Grid",
      "blocks": [
        { "type": "media" },
        { "type": "media" },
        { "type": "media" },
        { "type": "media" },
        { "type": "media" },
        { "type": "media" },
        { "type": "media" },
        { "type": "media" },
        { "type": "media" },
        { "type": "media" },
        { "type": "media" },
        { "type": "media" }
      ]
    }
  ]
}
{% endschema %}
